<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
    <link rel="stylesheet" href="style/custom-bootstrap.css">
    <link rel="stylesheet" href="style/style.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">

    <script type="module">
        import 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js';
        import { app } from './js/app.js';

        document.addEventListener('alpine:init', () => {
            Alpine.data('app', app);
        });
    </script>

    <title>Plex Movie Picker</title>
</head>

<body x-data="app()">

    <!-- Home Section -->
    <div class="container my-5" x-show="!currentMovie && !endOfVotesInfo.isDisplayed">

        <h1 class="text-center mb-4">
            Plex Movie Picker
        </h1>

        <section class="p-4 mb-5 border rounded">

            <div class="mb-3">
                <label for="selectMovieGenre" class="form-label">Select Movie Genre</label>
                <select class="form-select" id="selectMovieGenre" x-model="selectedGenreKey">
                    <template x-for="(genre, index) in genres" :key="index">
                        <option :value="genre.key" x-text="genre.label"></option>
                    </template>
                </select>
            </div>

            <div class="mb-3">
                <label for="selectMovieLength" class="form-label">Select Movie Length</label>
                <select class="form-select" id="selectMovieLength" x-on:change="selectDuration($event)">
                    <template x-for="category in movieLengthCategories" :key="category.label">
                        <option :value="stringifyDuration(category.duration)" x-text="category.label"></option>
                    </template>
                </select>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-secondary" type="button" @click="loadMoviesFromWatchlist"
                    :disabled="isLoadingWatchlist || isLoadingGenres">
                    <span x-show="isLoadingWatchlist" class="spinner-border spinner-border-sm"
                        aria-hidden="true"></span>
                    <span x-show="isLoadingWatchlist" role="status">Loading Watchlist...</span>
                    <span x-show="!isLoadingWatchlist">Load Movies From Watchlist</span>
                </button>
            </div>

            <p class="mt-3">Total Loaded Movies: <span x-text="watchlist.length"></span></p>

        </section>

        <section class="text-center" x-show="!currentMovie">
            <div class="d-grid gap-2">

                <button class="btn btn-primary" type="button" @click="initiateOrResumeVoting"
                    :disabled="watchlist.length <= 0 || isLoadingWatchlist">
                    Vote Movies
                </button>
                <button class="btn btn-secondary" type="button" @click="startRandomizing"
                    :disabled="watchlist.length <= 0 || isLoadingWatchlist">
                    Get Random Movie
                </button>

                <hr />

                <button class="btn btn-danger" type="button" @click="resetVotes"
                    :disabled="watchlist.length <= 0 || isLoadingWatchlist">
                    Reset All Votes
                </button>


            </div>
        </section>
    </div>

    <!-- Movie page -->
    <section x-show="currentMovie">
        <template x-if="currentMovie">
            <div>
                <div class="movie-container">

                    <!-- Back Arrow -->
                    <div class="back-arrow">
                        <a href="#" @click="currentMovie = null" class="link-light">
                            <img src="assets/icons/arrow-left.svg" alt="arrow-left" class="arrow-left-icon">
                        </a>
                    </div>

                    <!-- Cover -->
                    <div class="image-container">
                        <img :src="currentMovie.images.snapshot ? currentMovie.images.snapshot : currentMovie.images.background"
                            alt="bg-cover">
                        <div class="gradient-overlay"></div>
                    </div>

                    <!-- Main information -->
                    <div class="container">
                        <div class="row">
                            <div class="col-8">
                                <h1 class="display-6" x-text="currentMovie.title"></h1>
                                <p class="small text-secondary-emphasis">
                                    DIRECTED BY <strong x-text="currentMovie.director"></strong>
                                </p>
                                <p>
                                    <span x-text="currentMovie.year"></span> ãƒ»
                                    <span x-text="formatDuration(currentMovie.duration)"></span><br />
                                    <template x-for="name in currentMovie.countries" :key="name">
                                        <img x-show="name" :src="getCountryIcon(name)" :alt="`${name} flag`"
                                            class="m-0 flag">
                                    </template>
                                </p>
                            </div>
                            <div class="col-4 ps-0">
                                <img :src="currentMovie.images.coverPoster"
                                    class="img-fluid rounded position-relative cover-poster" alt="cover">
                            </div>
                        </div>

                        <!-- Ratings -->
                        <div class="container py-3">
                            <div class="row text-center">
                                <template x-for="rating in currentMovie.ratings" :key="rating.source">
                                    <div class="col-3 p-0">
                                        <img :src="getRatingIcon(rating)" :alt="rating.source" class="img-rating">
                                        <span x-text="getRatingLabel(rating)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Genres -->
                        <div class="row">
                            <div class="col d-flex justify-content-center flex-wrap px-3 pb-3">
                                <template x-for="genre in currentMovie.genres" :key="genre">
                                    <span class="badge rounded-pill text-bg-secondary m-1" x-text="genre"></span>
                                </template>
                            </div>
                        </div>

                        <p class="text-uppercase text-secondary-emphasis" x-text="currentMovie.tagline"></p>
                        <p x-text="currentMovie.summary250 ? currentMovie.summary250 : currentMovie.summary">
                        </p>

                        <h5>Casting</h5>
                        <div class="row">
                            <template x-for="cast in currentMovie.casting" :key="cast.id">
                                <div class="col d-flex justify-content-center flex-wrap w-25 text-center">
                                    <img class="rounded-circle w-100" :alt="cast.thumb" :src="cast.thumb" />
                                    <small class="d-inline-block text-truncate cast-label" x-text="cast.name"></small>
                                    <small class="d-inline-block text-truncate text-secondary cast-label"
                                        x-text="cast.role"></small>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="sticky-bottom movie-footer p-4">

                    <!-- Random button -->
                    <div class="row" x-show="activeMode === 'randomizing'">
                        <div class="col d-grid gap-2">
                            <button class="btn btn-primary" type="button" @click="getRandomMovie"
                                :disabled="isLoadingMovie">
                                Get Random Movie
                            </button>
                        </div>
                    </div>

                    <!-- Voting buttons -->
                    <div class="row" x-show="activeMode === 'voting'">
                        <div class="col d-grid">
                            <button class="btn btn-secondary w-100" type="button" @click="vote(-1)"
                                :disabled="isLoadingMovie">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-hand-thumbs-down-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M6.956 14.534c.065.936.952 1.659 1.908 1.42l.261-.065a1.38 1.38 0 0 0 1.012-.965c.22-.816.533-2.512.062-4.51q.205.03.443.051c.713.065 1.669.071 2.516-.211.518-.173.994-.68 1.2-1.272a1.9 1.9 0 0 0-.234-1.734c.058-.118.103-.242.138-.362.077-.27.113-.568.113-.856 0-.29-.036-.586-.113-.857a2 2 0 0 0-.16-.403c.169-.387.107-.82-.003-1.149a3.2 3.2 0 0 0-.488-.9c.054-.153.076-.313.076-.465a1.86 1.86 0 0 0-.253-.912C13.1.757 12.437.28 11.5.28H8c-.605 0-1.07.08-1.466.217a4.8 4.8 0 0 0-.97.485l-.048.029c-.504.308-.999.61-2.068.723C2.682 1.815 2 2.434 2 3.279v4c0 .851.685 1.433 1.357 1.616.849.232 1.574.787 2.132 1.41.56.626.914 1.28 1.039 1.638.199.575.356 1.54.428 2.591" />
                                </svg>
                                Nope
                            </button>
                        </div>
                        <div class="col d-grid">
                            <button class="btn btn-primary w-100" type="button" @click="vote(1)"
                                :disabled="isLoadingMovie">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-hand-thumbs-up-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M6.956 1.745C7.021.81 7.908.087 8.864.325l.261.066c.463.116.874.456 1.012.965.22.816.533 2.511.062 4.51a10 10 0 0 1 .443-.051c.713-.065 1.669-.072 2.516.21.518.173.994.681 1.2 1.273.184.532.16 1.162-.234 1.733q.086.18.138.363c.077.27.113.567.113.856s-.036.586-.113.856c-.039.135-.09.273-.16.404.169.387.107.819-.003 1.148a3.2 3.2 0 0 1-.488.901c.054.152.076.312.076.465 0 .305-.089.625-.253.912C13.1 15.522 12.437 16 11.5 16H8c-.605 0-1.07-.081-1.466-.218a4.8 4.8 0 0 1-.97-.484l-.048-.03c-.504-.307-.999-.609-2.068-.722C2.682 14.464 2 13.846 2 13V9c0-.85.685-1.432 1.357-1.615.849-.232 1.574-.787 2.132-1.41.56-.627.914-1.28 1.039-1.639.199-.575.356-1.539.428-2.59z" />
                                </svg>
                                Yay!
                            </button>
                        </div>
                    </div>

                    <div class="footer-gradient"></div>
                </div>
            </div>
        </template>
    </section>

    <!-- End of votes message (waiting, matching, failing, etc.) -->
    <section x-show="endOfVotesInfo.isDisplayed" class="min-vh-100">

        <div class="back-arrow">
            <a href="#" @click="endOfVotesInfo.isDisplayed = false" class="link-light">
                <img src="assets/icons/arrow-left.svg" alt="arrow-left" class="arrow-left-icon">
            </a>
        </div>

        <div class="image-container">
            <img :src="endOfVotesInfo.cover" alt="cover">
            <div class="gradient-overlay"></div>
        </div>

        <div class="container pt-4 text-center">
            <h1 class="display-1" x-text="endOfVotesInfo.headline"></h1>
            <p class="lead mt-4 text-start" x-text="endOfVotesInfo.message"></p>

            <div>
                <h1 class="display-6" x-text="endOfVotesInfo.title"></h1>
                <template x-if="endOfVotesInfo.poster">
                    <img :src="endOfVotesInfo.poster" class="img-fluid rounded w-50 my-4" alt="cover">
                </template>
            </div>

            <div class="container fixed-bottom mb-4" x-show="endOfVotesInfo.id !== 'match'">
                <div class="d-grid gap-2">

                    <button class="btn btn-primary" type="button" @click="restartUserVoting"
                        x-show="endOfVotesInfo.id === 'no-upvotes'">
                        Vote again
                    </button>

                    <button class="btn btn-primary" type="button" @click="restartVoting"
                        x-show="endOfVotesInfo.id === 'no-match'">
                        Restart voting
                    </button>

                    <button class="btn btn-secondary" type="button" @click="endOfVotesInfo.isDisplayed = false">
                        Back
                    </button>
                </div>
            </div>
        </div>

    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

</body>

</html>